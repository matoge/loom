<!DOCTYPE html>
<html>
<head>
    <title>Debug Test</title>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <style>
        body { margin: 0; background: #333; }
        canvas { width: 100%; height: 100vh; }
        #debug { position: absolute; top: 10px; left: 10px; color: white; background: rgba(0,0,0,0.8); padding: 10px; }
        button { margin: 5px; padding: 10px 20px; font-size: 16px; }
    </style>
</head>
<body>
    <div id="debug">
        <div>Debug Log:</div>
        <div id="log"></div>
        <select id="preset-select">
            <option value="traffic_scene">Traffic Scene</option>
        </select>
        <button onclick="loadPreset()">Load Preset</button>
    </div>
    <canvas id="babylon-canvas"></canvas>

    <script>
        function log(msg) {
            document.getElementById('log').innerHTML += '<br>' + msg;
            console.log(msg);
        }

        let app = null;
        
        try {
            log('Starting initialization...');
            
            const canvas = document.getElementById('babylon-canvas');
            const engine = new BABYLON.Engine(canvas, true);
            const scene = new BABYLON.Scene(engine);
            scene.clearColor = new BABYLON.Color3(0.1, 0.1, 0.2);
            
            const camera = new BABYLON.ArcRotateCamera('camera', 0, Math.PI/3, 20, BABYLON.Vector3.Zero(), scene);
            camera.attachControl(canvas, true);
            
            const light = new BABYLON.HemisphericLight('light', new BABYLON.Vector3(0, 1, 0), scene);
            
            // Simple ground
            const ground = BABYLON.MeshBuilder.CreateGround('ground', {width: 50, height: 50}, scene);
            ground.material = new BABYLON.StandardMaterial('groundMat', scene);
            ground.material.diffuseColor = new BABYLON.Color3(0.2, 0.2, 0.2);
            
            engine.runRenderLoop(() => scene.render());
            window.addEventListener('resize', () => engine.resize());
            
            app = { scene, engine, pointCloud: null };
            log('✅ Babylon.js initialized successfully');
            
        } catch (error) {
            log('❌ Error initializing: ' + error.message);
        }

        async function loadPreset() {
            try {
                log('Loading preset...');
                
                const response = await fetch('http://localhost:8001/api/pointcloud/generate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        preset: 'traffic_scene',
                        num_points: 1000
                    })
                });
                
                if (!response.ok) {
                    throw new Error('API responded with: ' + response.status);
                }
                
                const data = await response.json();
                log('✅ Got ' + data.points.length + ' points from API');
                
                // Display points
                if (app.pointCloud) {
                    app.pointCloud.dispose();
                }
                
                const pcs = new BABYLON.PointsCloudSystem('pcs', 1, app.scene);
                pcs.addPoints(data.points.length, (particle, i) => {
                    const point = data.points[i];
                    particle.position = new BABYLON.Vector3(-point[1], point[2], point[0]);
                    particle.color = new BABYLON.Color4(0.8, 0.6, 0.4, 1);
                });
                
                pcs.buildMeshAsync().then(() => {
                    app.pointCloud = pcs.mesh;
                    log('✅ Point cloud rendered');
                });
                
            } catch (error) {
                log('❌ Error loading preset: ' + error.message);
            }
        }
    </script>
</body>
</html>